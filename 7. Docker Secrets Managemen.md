 üß† **SOP: Docker Secrets Management**

---

## **1. Overview**

Docker Secrets is a **secure mechanism to store and manage sensitive data** ‚Äî such as passwords, API keys, SSH keys, and TLS certificates ‚Äî so that they **aren‚Äôt hardcoded** in images, environment variables, or plaintext files.

Docker Secrets encrypts this data at rest and in transit, and makes it available only to containers running as **Docker Swarm services** that are authorized to access it.

---

## **2. Why We Use Docker Secrets**

| **Reason**             | **Explanation**                                                                                |
| ---------------------- | ---------------------------------------------------------------------------------------------- |
| **Security**           | Secrets are encrypted and never written to disk in plaintext.                                  |
| **Access Control**     | Secrets are shared only with containers that explicitly request them.                          |
| **Central Management** | Secrets can be created, updated, and revoked without rebuilding images.                        |
| **Auditability**       | You can track which service is using which secret.                                             |
| **Compliance**         | Helps meet security policies that forbid storing passwords in images or environment variables. |

---

## **3. Important Limitation: Why Secrets Work Only with Services (Not Standalone Containers)**

**Docker Secrets only work with Docker Swarm services**, *not standalone containers started with `docker run`.*

### **Reason:**

Secrets are distributed securely by the **Swarm Manager** to service tasks.
Standalone containers (`docker run`) have no manager node or service orchestration layer ‚Äî hence, there‚Äôs **no secure channel** to deliver and manage secrets.

| **Type**                | **Supported for Secrets?** | **Reason**                                                                   |
| ----------------------- | -------------------------- | ---------------------------------------------------------------------------- |
| `docker service create` | ‚úÖ Yes                      | Runs in a Swarm environment with secret distribution control.                |
| `docker run`            | ‚ùå No                       | No encrypted Swarm network or service orchestration layer to handle secrets. |

---

## **4. Prerequisites**

* Docker Engine 1.13 or newer
* Docker Swarm mode initialized (`docker swarm init`)
* User with manager privileges in the swarm

---

## **5. Creating a Docker Secret**

### **5.1. Create from Standard Input (CLI)**

```bash
echo "mysecretpassword" | docker secret create db_password -
```

**Explanation:**

* `echo "mysecretpassword"` ‚Üí sends data to standard output.
* `docker secret create` ‚Üí creates a new secret.
* `db_password` ‚Üí name of the secret.
* `-` ‚Üí means Docker reads the secret value from stdin.

**Real Output:**

```
hx9jqmv1thp95tmrdrgqt5u7c
```

‚úÖ *This is the unique secret ID assigned by Docker.*

---

### **5.2. Create from a File**

```bash
docker secret create api_key ./apikey.txt
```

**Explanation:**

* `api_key` ‚Üí name of the secret.
* `./apikey.txt` ‚Üí file containing secret data.

**Real Output:**

```
zgzjchjx8f7hwlw8t6k3h2l2v
```

---

## **6. Listing Secrets**

```bash
docker secret ls
```

**Explanation:**
Lists all secrets currently available in the swarm.

| **Column**  | **Meaning**                     |
| ----------- | ------------------------------- |
| **ID**      | Unique identifier of the secret |
| **NAME**    | User-defined secret name        |
| **CREATED** | When the secret was created     |
| **UPDATED** | When it was last updated        |

**Real Output:**

```
ID                          NAME         CREATED          UPDATED
hx9jqmv1thp95tmrdrgqt5u7c   db_password  2 minutes ago    2 minutes ago
zgzjchjx8f7hwlw8t6k3h2l2v   api_key      1 minute ago     1 minute ago
```

---

## **7. Inspect a Secret**

```bash
docker secret inspect db_password
```

**Explanation:**
Shows metadata about a secret, but **not the secret data itself.**

**Real Output:**

```json
[
  {
    "ID": "hx9jqmv1thp95tmrdrgqt5u7c",
    "Version": {
      "Index": 12
    },
    "CreatedAt": "2025-10-16T05:12:10.841234Z",
    "UpdatedAt": "2025-10-16T05:12:10.841234Z",
    "Spec": {
      "Name": "db_password",
      "Labels": {}
    }
  }
]
```

---

## **8. Attaching Secrets to a Service**

When you deploy a service in Docker Swarm, you can attach one or more secrets to it.

### **8.1. Attach Secret at Service Creation**

```bash
docker service create \
  --name webapp \
  --secret db_password \
  nginx:latest
```

**Explanation:**

* `--secret db_password` ‚Üí mounts secret inside the container.
* Inside container path: `/run/secrets/db_password`

**Real Output:**

```
overall progress: 1 out of 1 tasks 
verify: Service converged
```

**Verification:**

```bash
docker exec -it $(docker ps -q --filter name=webapp) cat /run/secrets/db_password
```

**Real Output:**

```
mysecretpassword
```

---

## **9. Adding Secrets to an Existing Service**

```bash
docker service update --secret-add api_key webapp
```

**Explanation:**

* Adds a new secret to an existing service.
* Docker automatically redeploys tasks with the new secret mounted.

---

## **10. Removing Secrets from a Service**

```bash
docker service update --secret-rm db_password webapp
```

**Explanation:**

* Removes the `db_password` secret from the service and redeploys it securely.

---

## **11. Deleting a Secret**

```bash
docker secret rm db_password
```

**Explanation:**

* Permanently deletes the secret from the swarm store.

**Real Output:**

```
db_password
```

---

## **12. Multiple Ways to Share Secrets**

| **Method**         | **How It Works**                                               | **Use Case**                         |                               |
| ------------------ | -------------------------------------------------------------- | ------------------------------------ | ----------------------------- |
| **File Input**     | Use a local text file (`docker secret create mykey ./key.txt`) | Best for structured or long secrets. |                               |
| **Standard Input** | `echo "secret"                                                 | docker secret create key -`          | For quick, temporary secrets. |
| **Compose File**   | Define secrets directly in `docker-compose.yml`                | For multi-service applications.      |                               |

**Example: Using `docker-compose.yml`**

```yaml
version: '3.8'

services:
  db:
    image: mysql:latest
    secrets:
      - db_password

secrets:
  db_password:
    file: ./db_password.txt
```

---

## **13. Security Best Practices**

| **Best Practice**                                 | **Why It Matters**                          |
| ------------------------------------------------- | ------------------------------------------- |
| Never use secrets with `docker run`               | No Swarm = no encryption or secure delivery |
| Store secrets in files with 600 permissions       | Prevent unauthorized local reads            |
| Rotate secrets regularly                          | Avoid credential leaks                      |
| Use `docker secret rm` to clean up unused secrets | Prevent stale data                          |
| Avoid environment variables for secrets           | Env vars appear in process lists and logs   |

---

## **14. Summary**

| **Action**                     | **Command**                                           |                                   |
| ------------------------------ | ----------------------------------------------------- | --------------------------------- |
| Create Secret                  | `echo "pwd"                                           | docker secret create my_secret -` |
| List Secrets                   | `docker secret ls`                                    |                                   |
| Inspect Secret                 | `docker secret inspect my_secret`                     |                                   |
| Attach Secret to Service       | `docker service create --secret my_secret nginx`      |                                   |
| Add Secret to Existing Service | `docker service update --secret-add my_secret webapp` |                                   |
| Remove Secret from Service     | `docker service update --secret-rm my_secret webapp`  |                                   |
| Delete Secret                  | `docker secret rm my_secret`                          |                                   |
