# ⚙️ **SOP: Docker CPU 🧠 and Memory 💾 Management**

---

## 🧩 **1. Overview**

Docker allows you to **control CPU and memory usage per container or service**.
This prevents 🧱 *one container from hogging all system resources*, keeping your host and other containers stable.

✅ Modern Docker CLI encourages `docker container` commands for consistency.

---

## 🎯 **2. Why We Set CPU and Memory Limits**

| ⚠️ **Reason**           | 💡 **Explanation**                          | 🔧 **Use Case Example**                    |
| ----------------------- | ------------------------------------------- | ------------------------------------------ |
| 🧠 Prevent overload     | Stops a container from taking all CPU cores | A Python script in infinite loop           |
| 🚀 Improve performance  | Keeps CPU/memory usage predictable          | Web servers and databases running together |
| 💵 Save cost            | Optimizes compute usage                     | Multi-service shared production servers    |
| 🛡️ Improve reliability | Prevents kernel-level OOM kills             | Microservices on a single VM               |

---

## 🧰 **3. Prerequisites**

✅ Docker Engine 20.10+
✅ Linux host with cgroups enabled
✅ Basic container knowledge
✅ Swarm initialized for service-level limits (`docker swarm init`)

---

## 🧮 **4. CPU Management (Compute Control)**

---

### ⚙️ **4.1. Check Available Host CPUs**

```bash
lscpu | grep "^CPU(s)"
```

🧾 **Output:**

```
CPU(s):                4
```

💡 **Use Case:**
Know host capacity before allocating CPU to containers.

**Terms Explained:**

* **CPU(s)** → Number of logical cores available on the host.
* **Logical vs Physical CPUs** → Hyper-threaded cores count as logical CPUs.

---

### 🧠 **4.2. Limit CPU Cores (`--cpus`)**

```bash
docker container run -d --name cpu_limit_test --cpus="1.5" nginx
```

🧾 **Output:**

```
a81c7f0a2d9a39aabce2b3e8b4f9cb49d1afdc6e5d643f6d53b1f4d44a5ed3f6
```

✅ **Check stats:**

```bash
docker container stats cpu_limit_test
```

🧾 **Example Output:**

```
CONTAINER ID   NAME             CPU %   MEM USAGE / LIMIT   MEM %   NET I/O     BLOCK I/O   PIDS
a81c7f0a2d9a   cpu_limit_test   38.54%  5.5MiB / 512MiB     1.07%   2.4kB / 0B  0B / 8.2kB  2
```

💡 **Use Case:**
Running multiple Nginx servers without one dominating CPU.

**Terms Explained:**

* **CPU %** → Approximate CPU usage of the container.
* **MEM USAGE / LIMIT** → Current memory usage vs memory limit set.

---

### ⚙️ **4.3. Pin Container to Specific Cores (`--cpuset-cpus`)**

```bash
docker container run -d --name webapp_cpu2 --cpuset-cpus="0,2" nginx
```

🧾 **Verify:**

```bash
docker container inspect webapp_cpu2 --format='{{.HostConfig.CpusetCpus}}'
```

Output:

```
0,2
```

💡 **Use Case:**
CPU-intensive workloads like video processing or analytics.

**Terms Explained:**

* **Cpuset-cpus** → Specifies exact cores container can use.
* Useful for predictable performance on dedicated cores.

---

### ⚖️ **4.4. CPU Shares (`--cpu-shares`)**

```bash
docker container run -d --name high_priority --cpu-shares=1024 nginx
docker container run -d --name low_priority --cpu-shares=512 nginx
```

**Terms Explained:**

* **CPU Shares** → Relative weight for CPU allocation. Not a hard limit.
* Higher number → more CPU time during contention.

💡 **Use Case:**
Prioritize API server over background tasks.

**Extra Output Example:**

```bash
docker container inspect high_priority --format '{{.HostConfig.CpuShares}}'
```

Output:

```
1024
```

---

## 💾 **5. Memory Management**

---

### 🧱 **5.1. Limit Memory Usage (`--memory`)**

```bash
docker container run -d --name mem_limit_test --memory="512m" nginx
```

🧾 **Verify:**

```bash
docker container inspect mem_limit_test --format='{{.HostConfig.Memory}}'
```

Output:

```
536870912
```

💡 **Use Case:**
Restrict low-priority service to avoid RAM overuse.

**Terms Explained:**

* **MemoryBytes** → Memory in bytes (512MB = 536870912 bytes).
* **Hard limit** → Container will be killed if exceeds this value.

---

### 🧠 **5.2. Soft Memory Limit (`--memory-reservation`)**

```bash
docker container run -d --name mem_soft_limit --memory="512m" --memory-reservation="256m" nginx
```

💡 **Use Case:**
Bursty workloads — temporary web spikes.

**Terms Explained:**

* **Memory Reservation** → Preferred minimum memory guaranteed.
* **Behavior** → Container can exceed reservation if system has free RAM.

---

### 🧮 **5.3. Control Swap (`--memory-swap`)**

```bash
docker container run -d --name swap_test --memory="256m" --memory-swap="512m" nginx
```

**Terms Explained:**

* **Memory** → RAM limit
* **Memory-swap** → RAM + swap combined
* **Example** → RAM=256MB, swap allowed=256MB

💡 **Use Case:**
Prevent swapping for latency-sensitive services like Redis.

**Extra Output Example:**

```bash
docker container inspect swap_test --format '{{.HostConfig.MemorySwap}}'
```

Output:

```
536870912
```

---

### 🧾 **5.4. Monitor Resource Usage**

```bash
docker container stats
```

🧾 **Example Output:**

```
CONTAINER ID   NAME             CPU %   MEM USAGE / LIMIT   MEM %   NET I/O       BLOCK I/O   PIDS
a81c7f0a2d9a   cpu_limit_test   38.54%  5.5MiB / 512MiB     1.07%   2.4kB / 0B    0B / 8.2kB  2
mem_limit_test  0.03%   4.9MiB / 512MiB     0.96%   1.2kB / 0B    0B / 8.2kB  2
```

---

## 🧱 **6. CPU & Memory Limits in Services (Swarm)**

```bash
docker service create \
  --name backend \
  --limit-cpu 1 \
  --limit-memory 512m \
  --reserve-cpu 0.5 \
  --reserve-memory 256m \
  nginx
```

🧾 **Verify:**

```bash
docker service inspect backend --format '{{.Spec.TaskTemplate.Resources}}'
```

Output:

```json
{"Limits":{"NanoCPUs":1000000000,"MemoryBytes":536870912},"Reservations":{"NanoCPUs":500000000,"MemoryBytes":268435456}}
```

**Terms Explained:**

* **NanoCPUs** → 1 CPU = 1,000,000,000 (nano units)
* **Limits** → Hard max
* **Reservations** → Minimum guaranteed

💡 **Use Case:**
Production web servers with predictable compute limits.

---

## 🧩 **7. Key Difference: Hard vs Soft Limits**

| ⚙️ **Type** | 🧠 **Behavior**                                     | 💡 **Use Case**     |
| ----------- | --------------------------------------------------- | ------------------- |
| Hard Limit  | Absolute boundary; container killed if exceeded     | Critical services   |
| Soft Limit  | Preferred baseline; flexible if memory is available | Burstable workloads |

---

## 🏁 **8. Summary Commands (Modern CLI)**

| 💬 **Task**           | ⚡ **Command**                                                            |
| --------------------- | ------------------------------------------------------------------------ |
| Limit CPU             | `docker container run --cpus="1.5" nginx`                                |
| Pin to CPU cores      | `docker container run --cpuset-cpus="0,2" nginx`                         |
| Set CPU shares        | `docker container run --cpu-shares=512 nginx`                            |
| Limit Memory          | `docker container run --memory="512m" nginx`                             |
| Set Soft Limit        | `docker container run --memory="512m" --memory-reservation="256m" nginx` |
| Limit Swap            | `docker container run --memory="256m" --memory-swap="512m" nginx`        |
| Monitor Usage         | `docker container stats`                                                 |
| Set Limits in Service | `docker service create --limit-cpu 1 --limit-memory 512m nginx`          |

