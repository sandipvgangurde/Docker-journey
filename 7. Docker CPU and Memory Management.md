# âš™ï¸ **SOP: Docker CPU ğŸ§  and Memory ğŸ’¾ Management**

---

## ğŸ§© **1. Overview**

Docker allows you to **control CPU and memory usage per container or service**.
This prevents ğŸ§± *one container from hogging all system resources*, keeping your host and other containers stable.

âœ… Modern Docker CLI encourages `docker container` commands for consistency.

---

## ğŸ¯ **2. Why We Set CPU and Memory Limits**

| âš ï¸ **Reason**           | ğŸ’¡ **Explanation**                          | ğŸ”§ **Use Case Example**                    |
| ----------------------- | ------------------------------------------- | ------------------------------------------ |
| ğŸ§  Prevent overload     | Stops a container from taking all CPU cores | A Python script in infinite loop           |
| ğŸš€ Improve performance  | Keeps CPU/memory usage predictable          | Web servers and databases running together |
| ğŸ’µ Save cost            | Optimizes compute usage                     | Multi-service shared production servers    |
| ğŸ›¡ï¸ Improve reliability | Prevents kernel-level OOM kills             | Microservices on a single VM               |

---

## ğŸ§° **3. Prerequisites**

âœ… Docker Engine 20.10+
âœ… Linux host with cgroups enabled
âœ… Basic container knowledge
âœ… Swarm initialized for service-level limits (`docker swarm init`)

---

## ğŸ§® **4. CPU Management (Compute Control)**

---

### âš™ï¸ **4.1. Check Available Host CPUs**

```bash
lscpu | grep "^CPU(s)"
```

ğŸ§¾ **Output:**

```
CPU(s):                4
```

ğŸ’¡ **Use Case:**
Know host capacity before allocating CPU to containers.

**Terms Explained:**

* **CPU(s)** â†’ Number of logical cores available on the host.
* **Logical vs Physical CPUs** â†’ Hyper-threaded cores count as logical CPUs.

---

### ğŸ§  **4.2. Limit CPU Cores (`--cpus`)**

```bash
docker container run -d --name cpu_limit_test --cpus="1.5" nginx
```

ğŸ§¾ **Output:**

```
a81c7f0a2d9a39aabce2b3e8b4f9cb49d1afdc6e5d643f6d53b1f4d44a5ed3f6
```

âœ… **Check stats:**

```bash
docker container stats cpu_limit_test
```

ğŸ§¾ **Example Output:**

```
CONTAINER ID   NAME             CPU %   MEM USAGE / LIMIT   MEM %   NET I/O     BLOCK I/O   PIDS
a81c7f0a2d9a   cpu_limit_test   38.54%  5.5MiB / 512MiB     1.07%   2.4kB / 0B  0B / 8.2kB  2
```

ğŸ’¡ **Use Case:**
Running multiple Nginx servers without one dominating CPU.

**Terms Explained:**

* **CPU %** â†’ Approximate CPU usage of the container.
* **MEM USAGE / LIMIT** â†’ Current memory usage vs memory limit set.

---

### âš™ï¸ **4.3. Pin Container to Specific Cores (`--cpuset-cpus`)**

```bash
docker container run -d --name webapp_cpu2 --cpuset-cpus="0,2" nginx
```

ğŸ§¾ **Verify:**

```bash
docker container inspect webapp_cpu2 --format='{{.HostConfig.CpusetCpus}}'
```

Output:

```
0,2
```

ğŸ’¡ **Use Case:**
CPU-intensive workloads like video processing or analytics.

**Terms Explained:**

* **Cpuset-cpus** â†’ Specifies exact cores container can use.
* Useful for predictable performance on dedicated cores.

---

### âš–ï¸ **4.4. CPU Shares (`--cpu-shares`)**

```bash
docker container run -d --name high_priority --cpu-shares=1024 nginx
docker container run -d --name low_priority --cpu-shares=512 nginx
```

**Terms Explained:**

* **CPU Shares** â†’ Relative weight for CPU allocation. Not a hard limit.
* Higher number â†’ more CPU time during contention.

ğŸ’¡ **Use Case:**
Prioritize API server over background tasks.

**Extra Output Example:**

```bash
docker container inspect high_priority --format '{{.HostConfig.CpuShares}}'
```

Output:

```
1024
```

---

## ğŸ’¾ **5. Memory Management**

---

### ğŸ§± **5.1. Limit Memory Usage (`--memory`)**

```bash
docker container run -d --name mem_limit_test --memory="512m" nginx
```

ğŸ§¾ **Verify:**

```bash
docker container inspect mem_limit_test --format='{{.HostConfig.Memory}}'
```

Output:

```
536870912
```

ğŸ’¡ **Use Case:**
Restrict low-priority service to avoid RAM overuse.

**Terms Explained:**

* **MemoryBytes** â†’ Memory in bytes (512MB = 536870912 bytes).
* **Hard limit** â†’ Container will be killed if exceeds this value.

---

### ğŸ§  **5.2. Soft Memory Limit (`--memory-reservation`)**

```bash
docker container run -d --name mem_soft_limit --memory="512m" --memory-reservation="256m" nginx
```

ğŸ’¡ **Use Case:**
Bursty workloads â€” temporary web spikes.

**Terms Explained:**

* **Memory Reservation** â†’ Preferred minimum memory guaranteed.
* **Behavior** â†’ Container can exceed reservation if system has free RAM.

---

### ğŸ§® **5.3. Control Swap (`--memory-swap`)**

```bash
docker container run -d --name swap_test --memory="256m" --memory-swap="512m" nginx
```

**Terms Explained:**

* **Memory** â†’ RAM limit
* **Memory-swap** â†’ RAM + swap combined
* **Example** â†’ RAM=256MB, swap allowed=256MB

ğŸ’¡ **Use Case:**
Prevent swapping for latency-sensitive services like Redis.

**Extra Output Example:**

```bash
docker container inspect swap_test --format '{{.HostConfig.MemorySwap}}'
```

Output:

```
536870912
```

---

### ğŸ§¾ **5.4. Monitor Resource Usage**

```bash
docker container stats
```

ğŸ§¾ **Example Output:**

```
CONTAINER ID   NAME             CPU %   MEM USAGE / LIMIT   MEM %   NET I/O       BLOCK I/O   PIDS
a81c7f0a2d9a   cpu_limit_test   38.54%  5.5MiB / 512MiB     1.07%   2.4kB / 0B    0B / 8.2kB  2
mem_limit_test  0.03%   4.9MiB / 512MiB     0.96%   1.2kB / 0B    0B / 8.2kB  2
```

---

## ğŸ§± **6. CPU & Memory Limits in Services (Swarm)**

```bash
docker service create \
  --name backend \
  --limit-cpu 1 \
  --limit-memory 512m \
  --reserve-cpu 0.5 \
  --reserve-memory 256m \
  nginx
```

ğŸ§¾ **Verify:**

```bash
docker service inspect backend --format '{{.Spec.TaskTemplate.Resources}}'
```

Output:

```json
{"Limits":{"NanoCPUs":1000000000,"MemoryBytes":536870912},"Reservations":{"NanoCPUs":500000000,"MemoryBytes":268435456}}
```

**Terms Explained:**

* **NanoCPUs** â†’ 1 CPU = 1,000,000,000 (nano units)
* **Limits** â†’ Hard max
* **Reservations** â†’ Minimum guaranteed

ğŸ’¡ **Use Case:**
Production web servers with predictable compute limits.

---

## ğŸ§© **7. Key Difference: Hard vs Soft Limits**

| âš™ï¸ **Type** | ğŸ§  **Behavior**                                     | ğŸ’¡ **Use Case**     |
| ----------- | --------------------------------------------------- | ------------------- |
| Hard Limit  | Absolute boundary; container killed if exceeded     | Critical services   |
| Soft Limit  | Preferred baseline; flexible if memory is available | Burstable workloads |

---

## ğŸ **8. Summary Commands (Modern CLI)**

| ğŸ’¬ **Task**           | âš¡ **Command**                                                            |
| --------------------- | ------------------------------------------------------------------------ |
| Limit CPU             | `docker container run --cpus="1.5" nginx`                                |
| Pin to CPU cores      | `docker container run --cpuset-cpus="0,2" nginx`                         |
| Set CPU shares        | `docker container run --cpu-shares=512 nginx`                            |
| Limit Memory          | `docker container run --memory="512m" nginx`                             |
| Set Soft Limit        | `docker container run --memory="512m" --memory-reservation="256m" nginx` |
| Limit Swap            | `docker container run --memory="256m" --memory-swap="512m" nginx`        |
| Monitor Usage         | `docker container stats`                                                 |
| Set Limits in Service | `docker service create --limit-cpu 1 --limit-memory 512m nginx`          |

